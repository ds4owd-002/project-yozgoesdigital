---
title: "Faecal sludge truck logistics analysis in Kampala, Uganda"
subtitle: "An exploration to understand the structure and trends of an informal faecal collection sector" 
author:
  name: "Jos van der Ent"
  orcid: 0009-0009-3940-3943
date: today
format: 
  html: 
    number-sections: true
    toc: true
    code-fold: true
    code-folding: true
crossref:
  chapters: true
bibliography: references.bib
execute: 
  echo: true #remove false before submitting as the requirements dictate to add the code to the report
  warning: true
license: "CC BY"
#csl: apa.csl # incase to use custom citation style
---

# Glossary {.unnumbered}

| Abbreviation | Comment       |
|:-------------|---------------|
| FS           | Faecal sludge |

# Introduction

The 'fslogisticskampala' data set is shared on [OpenWashdata](www.openwashdata.org) by Lars Sh√∂bitz. The goal of this dataset is to provide data sources on faecal sludge transporting logistics in Kampala, Uganda. The data is collected from 30th March 2015 until 25th June 2015 and contains the collection location and dislodge location. By reading the shared dataset and the written report the writer felt it would be interesting to see if there is more information and trends present in the dataset which has not be exposed in the narrative. This dataset is chosen for the Data Science for OpenWashData course. And this specific dataset as it contains location data, in form of GPS coordinates, and multiple datasets which can be joined for the analysis. Additionally it also contains time series which is a common aspect in dataset and so useful for getting hands-on experience

# METHODS: explore the raw data

## Import libraries
First the required libraries need to be imported to be able to read and process the datasets.

```{r libraries, message = FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(gt)
library(here)
library(gtsummary)
library(lubridate)
library(leaflet)
```

## Import trips data from 'fslogisticskampala'

The original set has 2 tables @lars_schobitz_fslogisticskampala_2024. One set contains information of trips of faecal sludge collection trucks and the second table with metadata on of the trucks. First we start with opening the trips.csv and save it as trips_raw: 
```{r read_trips}
#| message = FALSE 
trips_raw <- read_csv(here::here("data/raw/trips.csv"))
```

@tbl-trips-dictionary shows the dictionary of the trips dataset. 

```{r}
#| label: tbl-trips-dictionary
#| tbl-cap: "Dictionary for trips table"
#| message: FALSE 
read_csv(here::here("data/trips_dictionary.csv")) |>
    gt()
```
From the dictionary it can be seen the trips data has information about the each recorded trip. Where the 'numberplate'column can be used as the foreign key to link to the truck dataset as described below.

## Import trucks data from 'fslogisticskampala'
The second dataset to import is the trucks data as published in the website. Read trucks.csv and save as trucks_raw

```{r}
#| message = FALSE 
trucks_raw <- read_csv(here::here("data/raw/trucks.csv"))
```

@tbl-trucks-dictionary shows the dictionary of the trucks set. This is a more simple table containing meta data on the truck. It only contains 2 variables. The first is the 'numberplate' which can function as key to link to the trips dataset and the second variable is the volume of the specific truck in m3.
```{r}
#| label: tbl-trucks-dictionary
#| tbl-cap: "Dictionary for trucks table"
#| message: FALSE 
read_csv(here::here("data/trucks_dictionary.csv")) |>
gt()
```

## Import dim_date
In order to aid analysis a additional table is generated and imported. This table has a daily granularity and contains time intelligence information for the data collection period. 

## Checking data integrity
In order to understand the data we will first asses the raw data. First we will count all non NA values for each column (see @tbl-count-trips. In total 5663 records are in the dataset and it can be seen each column has no NA values. 

```{r}
#| label: tbl-count-trips
#| tbl-cap: "Count of "
# trips_tbl_sum <- trips_raw |>
  colSums(!is.na(trips_raw))
```

```{r}
#| label: fig-count_of_delivery_per_truck
#| fig-cap: "Count of recorded trips per truck"
trips_raw |> tbl_summary(include = numberplate)
```

#```{r}
#trips_tbl_sum <- waste_gt |>
#    filter(!is.na(generation_kg_capita))  |>
#    group_by(income_cat) |>
#    summarise(
#        count = n(),
#        mean = mean(generation_kg_capita),
#        sd = sd(generation_kg_capita),
#        median = median(generation_kg_capita),
#        min = min(generation_kg_capita),
#        max = max(generation_kg_capita)
#    )
#```

than generate the summary table:

#```{r}
#waste_tbl_income |>
#    gt() |>
#    tab_header(title = "Waste generation per capita (kg/year) by income group",
#               subtitle = "Data from 326 cities") |>
#    fmt_number(columns = count:max, decimals = 0) |>
#    cols_label(income_cat = "income category")
#```

The trucks data can be used as dimension table for the trips data to retrieve meta data from the trucks. In this case only the volume. In total 35 trucks are registered and each has a reported volume as an attribute:
```{r}
  colSums(!is.na(trucks_raw))
```

## Write data into folder with cleaned data

### trips
Write the cleaned trips data/processed data as csv after cleaning.
```{r}
trips <-  trips_raw |>
  mutate(numberplate = as.character(numberplate)) |>
  write_csv(here::here("data/processed/trips.csv"))
```
### trucks
```{r}
trucks <- trucks_raw |>
  mutate(numberplate = as.character(numberplate)) |>
  write_csv(here::here("data/processed/trucks.csv"))
```
### dim_date and dim_time
Since the dim_date and dim_time are generated for this specific reporting purpose it is directly put in the processed folder. This can be done as no additional cleaning steps are required. After reading the document the dataframes need to be generated so they can easily be references in the code.
```{r}
#| message: FALSE 
dim_date <- read_csv(here::here("data/processed/dim_date.csv"))
dim_time <- read_csv(here::here("data/processed/dim_time.csv"))
```

# METHODS: Generate Dataframe for analysis
<!---
Since the Mermaid plugin only seems to work on the highest chapter level this chapter is added as first heading.
-->
First the raw data is stored into the folder. This allows to make a versatile setup where cleaning steps can be incorporated into the used dataset when deemed necessary when analysis the results.
After saving the individual tables these will be linked according a 'star' schema based on the [@kimball_data_2013]. For the analysis the trips data is used as the fact table and the trucks and dim_date tables are linked as dimension tables over which the set can be grouped and filtered. @fig-df_star_schema shows the schematic of the start schema.

```{mermaid}
%%| label: fig-df_star_schema
%%| fig-cap: "Star schema of data frame"
erDiagram
    trips }o--o| trucks  : numberplate
    trips }o--o| dim_date : date
    trips }o--o| dim_time   : time
    trucks {
        id numberplate	
        integer volume
    }
    trips {
        id fid
        string numberplate
        date date
        time time
        float lat
        float lon
        string plant
    }
    dim_date {
        date date
        integer day
        string day_suffix
        integer week_day
        string week_day_name
        string week_day_name_short
        string week_dayname_first_letter
        integer day_of_year
        integer week_of_month
        integer week_of_year
        integer month
        string month_name
        string month_name_Short
        string month_name_first_letter
        integer quarter
        string quarter_name
        integer year
        integer yyyymm
        string year_month
        binary is_weekend
        date first_date_of_month
        date last_date_of_month
        date first_date_of_week
        date last_date_of_week
        string year_week
    }
    dim_time{
        integer hour12
        integer hour24
        integer minute_of_hour
        integer second_of_minute
        integer elapsed_minutes
        integer elapsed_seconds
        string am_pm
        time hhmmss
        binary working_hours
        integer part_of_day_sort
        string part_of_day
    }
    
```

In order generate the star schema the code below can be executed. This code will basically do a left_join for of each dimension table to the trips fact table. This generates a big table with 44 variables and 5653 tuples (or rows). 

```{r}
df <- trips |>
  left_join(trucks, by = join_by(numberplate )) |> 
  left_join(dim_date, by = join_by(date) ) |>
  left_join(dim_time, by = join_by(time == time_key))
```

# Results
Visuals:
@fig-distribution-size shows the distribution of truck sizes.
[] Truck sizing
```{r}
#| label: fig-distribution-size
#| fig-cap: "Distribution of truck sizes"
df |>
ggplot(aes(y = numberplate,
           x = volume
           )) +
  geom_point()
```


mixes?
#```{r}
#df |>
#ggplot(aes(x = 
#             y = ))+
#  geom_bar()
#```
Does size matter?


[] map location with color on location
```{r}
ggplot(df, aes(lon, lat)) + 
  geom_point(size = .25, show.legend = FALSE) +
  coord_quickmap()
```
#todo this list for proper mapping: https://ggplot2-book.org/maps.html or rather use leaflet: https://stackoverflow.com/questions/23130604/plot-coordinates-on-map

```{r}

#| label: fig-map_collection_locations
#| fig-cap: "Map with collection locations and the existing treatment plants"
m = leaflet(data = df) |>
   addTiles() |>
   addCircleMarkers(~lon, ~lat 
                    ,popup = ~as.character(plant)
                    , color = ~ifelse(plant == "Bugolobi" , "red", "blue")
                    , radius = 0.5
                    ) |>
  addMarkers(lng = ~c(32.6071673,32.5458844)
             ,lat = ~c(0.3190139,0.3472747)
             ,popup = ~c("Bugolobi","Lubigi")
             )
m
```

Does it look like they are closer
[] column graph with day of delivery
- Time
[] time of delivery
[] does time affect dislodge location



# Conclusions

# References

::: {#refs}
:::

# License

The original dataset on faecal sludge logistics was published under [CC-BY](https://github.com/openwashdata/fslogisticskampala/blob/main/LICENSE.md) The results of this report are under presented here under similar license:

# Ideas/actions

-   \[\] day and night time (dim time)
-   \[\] plot on a map
-   \[\] check for NA values etc
-   \[\] [requirements](https://ds4owd-002.github.io/website/content/project/#tbl-required-items)
